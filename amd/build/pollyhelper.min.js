define(["jquery","core/log"],function(a,b){"use strict";b.debug("Polly Url: initialising");return{sentenceURLs:[],wordstarts:[],wordcounts:[],textblock:!1,wordselector:"",sentenceselector:"",cloudpoodlltoken:"",voice:"",highlightmode:"",theplayer:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c,d,e,f,g,h){var i=this,j=c.text();this.textblock=c;this.sentenceselector=e;this.wordselector=f;this.cloudpoodlltoken=h;this.highlightmode=g;this.voice=d;this.theplayer=a;this.spanify_text_passage();for(var k=this.split_into_sentences(j),l=0,m=0;m<k.length;m++){this.wordstarts[m]=l;this.wordcounts[m]=this.split_into_words(k[m]).length;l=l+this.wordcounts[m];var n=k[m];this.fetch_polly_url(n,function(a){return function(b){i.sentenceURLs[a]=b}}(m))}},split_into_sentences:function split_into_sentences(a){a=a.replace(/\s+/g," ").trim();if(""===a){return[]}return a.match(/([^\.!\?]+[\.!\?"']+)|([^\.!\?"']+$)/g)},split_into_words:function split_into_words(a){a=a.replace(/\s+/g," ").trim();if(""===a){return[]}return a.split(" ")},fetch_polly_url:function fetch_polly_url(a,b){var c=new XMLHttpRequest,d=this;c.onreadystatechange=function(){if(4===this.readyState){if(200===c.status){var a=c.responseText,d=JSON.parse(a);if(d){if(0<d.returnCode){console.log(d.returnMessage);return!1}else if(0===d.returnCode){var e=d.returnMessage;b(e)}else{console.log("Polly Signed URL Request failed:");console.log(d)}}else{console.log("Polly Signed URL Request something bad happened")}}else{console.log("Polly Signed URL Request Not 200 response:"+c.status)}}};var e="wstoken="+this.cloudpoodlltoken+"&wsfunction="+"local_cpapi_fetch_polly_url"+"&moodlewsrestformat=json&text="+encodeURIComponent(a)+"&texttype=text&voice="+this.voice+"&appid=filter_poodll&owner=poodll&region=useast1";c.open("POST","https://cloud.poodll.com/webservice/rest/server.php",!0);c.setRequestHeader("Cache-Control","no-cache");c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.send(e)},isHTML:function isHTML(a){return /<([A-Za-z][A-Za-z0-9]*)\b[^>]*>(.*?)<\/\1>/.test(a)},spanify_text_passage:function spanify_text_passage(){var b=this,c=-1,d=this.textblock.find("*").contents().filter(function(){return 3===this.nodeType});d.each(function(){var d="";if("word"===b.highlightmode){for(var e=b.split_into_words(a(this).text()),f=0;f<e.length;f++){c++;d=d+"<span class=\"tbr_word\" data-wordindex=\""+c+"\">"+e[f]+"</span> "}}else{for(var g=b.split_into_sentences(a(this).text()),h=0;h<g.length;h++){c++;d=d+"<span class=\"tbr_sentence\" data-sentenceindex=\""+c+"\">"+g[h]+"</span>&nbsp;"}}a(this).replaceWith(d)})},dehighlight_all:function dehighlight_all(){switch(this.highlightmode){case"word":a(this.wordselector,this.textblock).removeClass("activesentence");break;case"sentence":a(this.sentenceselector).removeClass("activesentence");break;case"none":default:}},highlight_sentence:function highlight_sentence(b){switch(this.highlightmode){case"word":a(this.wordselector,this.textblock).removeClass("activesentence");a(this.wordselector,this.textblock).slice(this.wordstarts[b],this.wordstarts[b]+this.wordcounts[b]).addClass("activesentence");break;case"sentence":a(this.sentenceselector).removeClass("activesentence");a(this.sentenceselector+"[data-sentenceindex="+b+"]").addClass("activesentence");break;case"none":default:}},doplayaudio:function doplayaudio(a){this.dehighlight_all();this.highlight_sentence(a);this.theplayer.attr("src",this.sentenceURLs[a]);this.theplayer[0].load();this.theplayer[0].play()}}});
//# sourceMappingURL=pollyhelper.min.js.map
