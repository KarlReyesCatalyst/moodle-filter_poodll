define ("filter_poodll/pollyhelper",["jquery","core/log"],function(a,b){"use strict";b.debug("Polly Helper: initialising");return{sentenceURLs:[],sentencetexts:[],wordstarts:[],wordcounts:[],textblock:!1,textstring:!1,wordselector:"",sentenceselector:"",passagecssclass:"filterpoodll_pollytextblock_cont",cloudpoodlltoken:"",voice:"",highlightmode:"",theplayer:!1,pendingurls:0,clone:function clone(){return a.extend(!0,{},this)},reset:function reset(){this.unspanify_text_passage();this.textblock=!1;this.textstring=!1;this.sentenceURLs=[];this.sentencetexts=[];this.wordstarts=[];this.wordcounts=[]},set_textblock:function set_textblock(a){var c=this;if(a===this.textblock){b.debug("it was the same textblock");return}if(!1!==this.textblock){this.reset()}this.textblock=a;a.text();this.spanify_text_passage();this.sentencetexts=this.get_sentences_from_spanified_text();this.pendingurls=this.sentencetexts.length;for(var d=0,e=0;e<this.sentencetexts.length;e++){this.wordstarts[e]=d;this.wordcounts[e]=this.split_into_words(this.sentencetexts[e]).length;d=d+this.wordcounts[e];var f=this.sentencetexts[e];this.fetch_polly_url(f,function(a){return function(d){c.sentenceURLs[a]=d;b.debug(a+" "+d);c.pendingurls--}}(e))}},set_text:function set_text(a){var c=this;if(a===this.textstring){b.debug("it was the same textstring");return}if(!1!==this.textblock){this.reset()}this.textstring=a;this.sentencetexts[0]=a;this.pendingurls=1;this.fetch_polly_url(a,function(a){c.sentenceURLs[0]=a;b.debug("0 "+a);c.pendingurls--})},init:function init(a,b,c,d,e,f,g,h,i){this;this.sentenceselector=e;this.wordselector=f;this.passagecssclass=g;this.cloudpoodlltoken=i;this.highlightmode=h;this.voice=d;this.theplayer=a;this.set_textblock(c)},split_into_sentences:function split_into_sentences(a){a=a.replace(/\s+/g," ").trim();if(""===a){return[]}return a.match(/([^\.!\?]+[\.!\?"']+)|([^\.!\?"']+$)/g)},split_into_words:function split_into_words(a){a=a.replace(/\s+/g," ").trim();if(""===a){return[]}return a.split(" ")},fetch_polly_url:function fetch_polly_url(a,b){var c=new XMLHttpRequest,d=this;c.onreadystatechange=function(){if(4===this.readyState){if(200===c.status){var a=c.responseText,d=JSON.parse(a);if(d){if(0<d.returnCode){console.log(d.returnMessage);return!1}else if(0===d.returnCode){var e=d.returnMessage;b(e)}else{console.log("Polly Signed URL Request failed:");console.log(d)}}else{console.log("Polly Signed URL Request something bad happened")}}else{console.log("Polly Signed URL Request Not 200 response:"+c.status)}}};var e="wstoken="+this.cloudpoodlltoken+"&wsfunction="+"local_cpapi_fetch_polly_url"+"&moodlewsrestformat=json&text="+encodeURIComponent(a)+"&texttype=text&voice="+this.voice+"&appid=filter_poodll&owner=poodll&region=useast1";c.open("POST","https://cloud.poodll.com/webservice/rest/server.php",!0);c.setRequestHeader("Cache-Control","no-cache");c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.send(e)},isHTML:function isHTML(a){return /<([A-Za-z][A-Za-z0-9]*)\b[^>]*>(.*?)<\/\1>/.test(a)},unspanify_text_passage:function unspanify_text_passage(){this.textblock.removeClass(this.passagecssclass);if("word"===this.highlightmode){this.textblock.find(".tbr_word").contents().unwrap()}else{this.textblock.find(".tbr_sentence").contents().unwrap()}},spanify_text_passage:function spanify_text_passage(){var b=this,c=-1;this.textblock.addClass(this.passagecssclass);var d=this.textblock.find("*").contents().filter(function(){return 3===this.nodeType});d.each(function(){var d="";if("word"===b.highlightmode){for(var e=b.split_into_words(a(this).text()),f=0;f<e.length;f++){c++;d=d+"<span class=\"tbr_word\" data-wordindex=\""+c+"\">"+e[f]+"</span> "}}else{for(var g=b.split_into_sentences(a(this).text()),h=0;h<g.length;h++){c++;d=d+"<span class=\"tbr_sentence\" data-sentenceindex=\""+c+"\">"+g[h]+"</span>&nbsp;"}}a(this).replaceWith(d)})},get_sentences_from_spanified_text:function get_sentences_from_spanified_text(){var b=[],c=this.textblock.find("span.tbr_sentence");c.each(function(){b.push(a(this).text())});return b},dehighlight_all:function dehighlight_all(){switch(this.highlightmode){case"word":a(this.wordselector,this.textblock).removeClass("activesentence");break;case"sentence":a(this.sentenceselector).removeClass("activesentence");break;case"none":default:}},highlight_sentence:function highlight_sentence(b){switch(this.highlightmode){case"word":a(this.wordselector,this.textblock).removeClass("activesentence");a(this.wordselector,this.textblock).slice(this.wordstarts[b],this.wordstarts[b]+this.wordcounts[b]).addClass("activesentence");break;case"sentence":a(this.sentenceselector).removeClass("activesentence");a(this.sentenceselector+"[data-sentenceindex="+b+"]").addClass("activesentence");break;case"none":default:}},doplayaudio:function doplayaudio(a){var b=this;if(0<this.pendingurls){setTimeout(function(){b.doplayaudio(a)},100);return}if("number"==typeof a){this.dehighlight_all();this.highlight_sentence(a);this.theplayer.attr("src",this.sentenceURLs[a])}else{if(0<this.sentenceURLs.length){this.theplayer.attr("src",this.sentenceURLs[0])}}this.theplayer[0].load();this.theplayer[0].play()}}});
//# sourceMappingURL=pollyhelper.min.js.map
