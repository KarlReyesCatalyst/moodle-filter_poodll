{"version":3,"sources":["../src/pollyhelper.js"],"names":["define","$","log","debug","sentenceURLs","sentencetexts","wordstarts","wordcounts","textblock","textstring","wordselector","sentenceselector","passagecssclass","cloudpoodlltoken","voice","highlightmode","theplayer","pendingurls","clone","extend","reset","unspanify_text_passage","set_textblock","that","text","spanify_text_passage","get_sentences_from_spanified_text","length","previousend","currentsentence","split_into_words","speaktext","fetch_polly_url","sentenceindex","pollyurl","set_text","init","itemid","split_into_sentences","thetext","replace","trim","match","split","callback","xhr","XMLHttpRequest","onreadystatechange","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","console","returnMessage","xhrparams","encodeURIComponent","open","setRequestHeader","send","isHTML","testString","test","removeClass","find","contents","unwrap","itemcount","addClass","textnodes","filter","nodeType","each","retpieces","thewords","theword","thesentences","thesentence","replaceWith","sentences","spans","push","dehighlight_all","highlight_sentence","thesentence_index","slice","doplayaudio","setTimeout","attr","load","play"],"mappings":"AACAA,OAAM,6BAAC,CAAC,QAAD,CAAW,UAAX,CAAD,CAAyB,SAAUC,CAAV,CAAaC,CAAb,CAAkB,CAE7C,aAEAA,CAAG,CAACC,KAAJ,CAAU,4BAAV,EAEA,MAAO,CACHC,YAAY,CAAE,EADX,CAEHC,aAAa,CAAE,EAFZ,CAGHC,UAAU,CAAE,EAHT,CAIHC,UAAU,CAAE,EAJT,CAKHC,SAAS,GALN,CAMHC,UAAU,GANP,CAOHC,YAAY,CAAE,EAPX,CAQHC,gBAAgB,CAAE,EARf,CASHC,eAAe,CAAE,kCATd,CAUHC,gBAAgB,CAAE,EAVf,CAWHC,KAAK,CAAE,EAXJ,CAYHC,aAAa,CAAE,EAZZ,CAaHC,SAAS,GAbN,CAcHC,WAAW,CAAE,CAdV,CAiBHC,KAAK,CAAE,gBAAY,CACf,MAAOjB,CAAAA,CAAC,CAACkB,MAAF,IAAe,EAAf,CAAmB,IAAnB,CACV,CAnBE,CAqBHC,KAAK,CAAE,gBAAU,CACb,KAAKC,sBAAL,GACA,KAAKb,SAAL,IACA,KAAKC,UAAL,IACA,KAAKL,YAAL,CAAmB,EAAnB,CACA,KAAKC,aAAL,CAAoB,EAApB,CACA,KAAKC,UAAL,CAAiB,EAAjB,CACA,KAAKC,UAAL,CAAiB,EACpB,CA7BE,CA+BHe,aAAa,CAAE,uBAASd,CAAT,CAAmB,CAC9B,GAAIe,CAAAA,CAAI,CAAG,IAAX,CAGA,GAAGf,CAAS,GAAG,KAAKA,SAApB,CAA8B,CAC1BN,CAAG,CAACC,KAAJ,CAAU,2BAAV,EACA,MACH,CAED,GAAG,UAAKK,SAAR,CAA2B,CACnB,KAAKY,KAAL,EACP,CAED,KAAKZ,SAAL,CAAgBA,CAAhB,CACcA,CAAS,CAACgB,IAAV,EAdgB,CAiB9B,KAAKC,oBAAL,GACA,KAAKpB,aAAL,CAAqB,KAAKqB,iCAAL,EAArB,CACA,KAAKT,WAAL,CAAiB,KAAKZ,aAAL,CAAmBsB,MAApC,CAGA,OAFIC,CAAAA,CAAW,CAAG,CAElB,CAASC,CAAe,CAAG,CAA3B,CAA8BA,CAAe,CAAG,KAAKxB,aAAL,CAAmBsB,MAAnE,CAA2EE,CAAe,EAA1F,CAA6F,CACzF,KAAKvB,UAAL,CAAgBuB,CAAhB,EAAkCD,CAAlC,CACA,KAAKrB,UAAL,CAAgBsB,CAAhB,EAAkC,KAAKC,gBAAL,CAAsB,KAAKzB,aAAL,CAAmBwB,CAAnB,CAAtB,EAA2DF,MAA7F,CACAC,CAAW,CAAGA,CAAW,CAAG,KAAKrB,UAAL,CAAgBsB,CAAhB,CAA5B,CAEA,GAAIE,CAAAA,CAAS,CAAG,KAAK1B,aAAL,CAAmBwB,CAAnB,CAAhB,CACA,KAAKG,eAAL,CAAqBD,CAArB,CACI,SAASE,CAAT,CAAwB,CACpB,MAAO,UAASC,CAAT,CAAmB,CACtBX,CAAI,CAACnB,YAAL,CAAkB6B,CAAlB,EAAmCC,CAAnC,CACAhC,CAAG,CAACC,KAAJ,CAAU8B,CAAa,CAAG,GAAhB,CAAsBC,CAAhC,EACAX,CAAI,CAACN,WAAL,EACH,CACJ,CAND,CAMEY,CANF,CADJ,CASH,CACJ,CArEE,CAuEHM,QAAQ,CAAE,kBAAS1B,CAAT,CAAoB,CAC1B,GAAIc,CAAAA,CAAI,CAAG,IAAX,CAEA,GAAGd,CAAU,GAAG,KAAKA,UAArB,CAAiC,CAC7BP,CAAG,CAACC,KAAJ,CAAU,4BAAV,EACA,MACH,CAED,GAAG,UAAKK,SAAR,CAA2B,CACvB,KAAKY,KAAL,EACH,CAGD,KAAKX,UAAL,CAAiBA,CAAjB,CACA,KAAKJ,aAAL,CAAmB,CAAnB,EAAsBI,CAAtB,CACA,KAAKQ,WAAL,CAAiB,CAAjB,CACA,KAAKe,eAAL,CAAqBvB,CAArB,CACI,SAASyB,CAAT,CAAkB,CACdX,CAAI,CAACnB,YAAL,CAAkB,CAAlB,EAAuB8B,CAAvB,CACAhC,CAAG,CAACC,KAAJ,CAAU,KAAY+B,CAAtB,EACAX,CAAI,CAACN,WAAL,EACH,CALL,CAQH,CA/FE,CAiGHmB,IAAI,CAAE,cAAUpB,CAAV,CAAoBqB,CAApB,CAA4B7B,CAA5B,CAAuCM,CAAvC,CAA6CH,CAA7C,CAA8DD,CAA9D,CAA2EE,CAA3E,CAA2FG,CAA3F,CAA0GF,CAA1G,CAA4H,CACnH,IADmH,CAE9H,KAAKF,gBAAL,CAAuBA,CAAvB,CACA,KAAKD,YAAL,CAAmBA,CAAnB,CACA,KAAKE,eAAL,CAAsBA,CAAtB,CACA,KAAKC,gBAAL,CAAwBA,CAAxB,CACA,KAAKE,aAAL,CAAmBA,CAAnB,CACA,KAAKD,KAAL,CAAaA,CAAb,CACA,KAAKE,SAAL,CAAiBA,CAAjB,CAEA,KAAKM,aAAL,CAAmBd,CAAnB,CAEH,CA7GE,CAgHH8B,oBAAoB,CAAE,8BAASC,CAAT,CAAiB,CACnCA,CAAO,CAAGA,CAAO,CAACC,OAAR,CAAgB,MAAhB,CAAuB,GAAvB,EAA4BC,IAA5B,EAAV,CACA,GAAc,EAAX,GAAAF,CAAH,CAAiB,CAAC,MAAM,EAAI,CAC5B,MAAOA,CAAAA,CAAO,CAACG,KAAR,CAAc,uCAAd,CACV,CApHE,CAuHHZ,gBAAgB,CAAE,0BAASS,CAAT,CAAiB,CAC/BA,CAAO,CAAGA,CAAO,CAACC,OAAR,CAAgB,MAAhB,CAAuB,GAAvB,EAA4BC,IAA5B,EAAV,CACA,GAAa,EAAV,GAAAF,CAAH,CAAgB,CAAC,MAAM,EAAI,CAC3B,MAAOA,CAAAA,CAAO,CAACI,KAAR,CAAc,GAAd,CACV,CA3HE,CA8HHX,eAAe,CAAE,yBAAUD,CAAV,CAAqBa,CAArB,CAA+B,IAOxCC,CAAAA,CAAG,CAAG,GAAIC,CAAAA,cAP8B,CAQxCvB,CAAI,CAAG,IARiC,CAW5CsB,CAAG,CAACE,kBAAJ,CAAyB,UAAa,CAClC,GAAwB,CAApB,QAAKC,UAAT,CAA2B,CACvB,GAAmB,GAAf,GAAAH,CAAG,CAACI,MAAR,CAAwB,IAGhBC,CAAAA,CAAO,CAAGL,CAAG,CAACM,YAHE,CAIhBC,CAAa,CAAGC,IAAI,CAACC,KAAL,CAAWJ,CAAX,CAJA,CAKpB,GAAIE,CAAJ,CAAmB,CAEf,GAA+B,CAA3B,CAAAA,CAAa,CAACG,UAAlB,CAAkC,CAC9BC,OAAO,CAACtD,GAAR,CAAYkD,CAAa,CAACK,aAA1B,EACA,QAEH,CAJD,IAIO,IAAiC,CAA7B,GAAAL,CAAa,CAACG,UAAlB,CAAmC,CACtC,GAAIrB,CAAAA,CAAQ,CAAGkB,CAAa,CAACK,aAA7B,CACAb,CAAQ,CAACV,CAAD,CACX,CAHM,IAGA,CACHsB,OAAO,CAACtD,GAAR,CAAY,kCAAZ,EACAsD,OAAO,CAACtD,GAAR,CAAYkD,CAAZ,CACH,CACJ,CAbD,IAaO,CACHI,OAAO,CAACtD,GAAR,CAAY,iDAAZ,CACH,CACJ,CArBD,IAqBO,CACHsD,OAAO,CAACtD,GAAR,CAAY,6CAA+C2C,CAAG,CAACI,MAA/D,CACH,CACJ,CACJ,CA3BD,CAX4C,GAyCxCS,CAAAA,CAAS,CAAG,WAAa,KAAK7C,gBAAlB,CACN,cADM,gEAGK8C,kBAAkB,CAAC5B,CAAD,CAHvB,yBAKM,KAAKjB,KALX,mDAzC4B,CAoD5C+B,CAAG,CAACe,IAAJ,CAAS,MAAT,2DACAf,CAAG,CAACgB,gBAAJ,CAAqB,eAArB,CAAsC,UAAtC,EACAhB,CAAG,CAACgB,gBAAJ,CAAqB,cAArB,CAAqC,mCAArC,EACAhB,CAAG,CAACiB,IAAJ,CAASJ,CAAT,CACH,CAtLE,CA0LHK,MAAM,CAAE,gBAAUC,CAAV,CAAsB,CAE1B,MAAO,8CAAUC,IAAV,CAAeD,CAAf,CACV,CA7LE,CA+LH3C,sBAAsB,CAAE,iCAAU,CAG9B,KAAKb,SAAL,CAAe0D,WAAf,CAA2B,KAAKtD,eAAhC,EAGA,GAAwB,MAArB,QAAKG,aAAR,CAA+B,CAC3B,KAAKP,SAAL,CAAe2D,IAAf,CAAoB,WAApB,EAAiCC,QAAjC,GAA4CC,MAA5C,EACH,CAFD,IAEO,CAEH,KAAK7D,SAAL,CAAe2D,IAAf,CAAoB,eAApB,EAAqCC,QAArC,GAAgDC,MAAhD,EACH,CACJ,CA3ME,CA8MH5C,oBAAoB,CAAE,+BAAU,IACxBF,CAAAA,CAAI,CAAG,IADiB,CAIxB+C,CAAS,CAAG,CAAC,CAJW,CAO5B,KAAK9D,SAAL,CAAe+D,QAAf,CAAwB,KAAK3D,eAA7B,EAGA,GAAI4D,CAAAA,CAAS,CAAG,KAAKhE,SAAL,CAAe2D,IAAf,CAAoB,GAApB,EAAyBC,QAAzB,GAAoCK,MAApC,CAA2C,UAAU,CAAE,MAAyB,EAAlB,QAAKC,QAAiB,CAApF,CAAhB,CAEAF,CAAS,CAACG,IAAV,CAAe,UAAU,CACrB,GAAIC,CAAAA,CAAS,CAAG,EAAhB,CACA,GAAwB,MAArB,GAAArD,CAAI,CAACR,aAAR,CAA+B,CAG3B,OADI8D,CAAAA,CAAQ,CAAGtD,CAAI,CAACO,gBAAL,CAAsB7B,CAAC,CAAC,IAAD,CAAD,CAAQuB,IAAR,EAAtB,CACf,CAASsD,CAAO,CAAG,CAAnB,CAAsBA,CAAO,CAAGD,CAAQ,CAAClD,MAAzC,CAAiDmD,CAAO,EAAxD,CAA2D,CACvDR,CAAS,GACTM,CAAS,CAAIA,CAAS,CAAG,4CAAZ,CAAuDN,CAAvD,CAAkE,KAAlE,CAAyEO,CAAQ,CAACC,CAAD,CAAjF,CAA6F,UAC7G,CACJ,CAPD,IAOO,CAGH,OADIC,CAAAA,CAAY,CAAGxD,CAAI,CAACe,oBAAL,CAA0BrC,CAAC,CAAC,IAAD,CAAD,CAAQuB,IAAR,EAA1B,CACnB,CAASwD,CAAW,CAAC,CAArB,CAAwBA,CAAW,CAAGD,CAAY,CAACpD,MAAnD,CAA2DqD,CAAW,EAAtE,CAAyE,CACrEV,CAAS,GACTM,CAAS,CAAIA,CAAS,CAAG,oDAAZ,CAA+DN,CAA/D,CAA0E,KAA1E,CAAiFS,CAAY,CAACC,CAAD,CAA7F,CAA6G,eAC7H,CACJ,CACD/E,CAAC,CAAC,IAAD,CAAD,CAAQgF,WAAR,CAAoBL,CAApB,CACH,CAlBD,CAmBH,CA7OE,CA+OHlD,iCAAiC,CAAE,4CAAU,IACrCwD,CAAAA,CAAS,CAAG,EADyB,CAErCC,CAAK,CAAG,KAAK3E,SAAL,CAAe2D,IAAf,CAAoB,mBAApB,CAF6B,CAGzCgB,CAAK,CAACR,IAAN,CAAW,UAAU,CACjBO,CAAS,CAACE,IAAV,CAAenF,CAAC,CAAC,IAAD,CAAD,CAAQuB,IAAR,EAAf,CACH,CAFD,EAGA,MAAO0D,CAAAA,CACV,CAtPE,CAyPHG,eAAe,CAAE,0BAAU,CACvB,OAAO,KAAKtE,aAAZ,EACI,IAAK,MAAL,CACId,CAAC,CAAC,KAAKS,YAAN,CAAmB,KAAKF,SAAxB,CAAD,CAAoC0D,WAApC,CAAgD,gBAAhD,EACA,MACJ,IAAK,UAAL,CACIjE,CAAC,CAAC,KAAKU,gBAAN,CAAD,CAAyBuD,WAAzB,CAAqC,gBAArC,EACA,MACJ,IAAK,MAAL,CACA,QARJ,CAWH,CArQE,CAwQHoB,kBAAkB,CAAE,4BAASC,CAAT,CAA2B,CAC3C,OAAO,KAAKxE,aAAZ,EACI,IAAK,MAAL,CACId,CAAC,CAAC,KAAKS,YAAN,CAAmB,KAAKF,SAAxB,CAAD,CAAoC0D,WAApC,CAAgD,gBAAhD,EACAjE,CAAC,CAAC,KAAKS,YAAN,CAAmB,KAAKF,SAAxB,CAAD,CAAoCgF,KAApC,CAA0C,KAAKlF,UAAL,CAAgBiF,CAAhB,CAA1C,CACQ,KAAKjF,UAAL,CAAgBiF,CAAhB,EACA,KAAKhF,UAAL,CAAgBgF,CAAhB,CAFR,EAE4ChB,QAF5C,CAEqD,gBAFrD,EAGA,MACJ,IAAK,UAAL,CACItE,CAAC,CAAC,KAAKU,gBAAN,CAAD,CAAyBuD,WAAzB,CAAqC,gBAArC,EACAjE,CAAC,CAAC,KAAKU,gBAAL,CAAwB,sBAAxB,CAAiD4E,CAAjD,CAAqE,GAAtE,CAAD,CAA4EhB,QAA5E,CAAqF,gBAArF,EACA,MACJ,IAAK,MAAL,CACA,QAZJ,CAeH,CAxRE,CA2RHkB,WAAW,CAAE,qBAAST,CAAT,CAAsB,CAC/B,GAAIzD,CAAAA,CAAI,CAAC,IAAT,CACA,GAAoB,CAAjB,MAAKN,WAAR,CAAsB,CAClByE,UAAU,CAAC,UAAU,CAACnE,CAAI,CAACkE,WAAL,CAAiBT,CAAjB,CAA+B,CAA3C,CAA4C,GAA5C,CAAV,CACA,MACH,CACD,GAA2B,QAAvB,QAAOA,CAAAA,CAAX,CAAqC,CAEjC,KAAKK,eAAL,GACA,KAAKC,kBAAL,CAAwBN,CAAxB,EACA,KAAKhE,SAAL,CAAe2E,IAAf,CAAoB,KAApB,CAA2B,KAAKvF,YAAL,CAAkB4E,CAAlB,CAA3B,CAIH,CARD,IAQO,CACH,GAA8B,CAA3B,MAAK5E,YAAL,CAAkBuB,MAArB,CAAiC,CAC7B,KAAKX,SAAL,CAAe2E,IAAf,CAAoB,KAApB,CAA2B,KAAKvF,YAAL,CAAkB,CAAlB,CAA3B,CACH,CACJ,CACD,KAAKY,SAAL,CAAe,CAAf,EAAkB4E,IAAlB,GACA,KAAK5E,SAAL,CAAe,CAAf,EAAkB6E,IAAlB,EACH,CAhTE,CAkTV,CAxTK,CAAN","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('Polly Helper: initialising');\n\n    return {\n        sentenceURLs: [],\n        sentencetexts: [],\n        wordstarts: [],\n        wordcounts: [],\n        textblock: false,\n        textstring: false,\n        wordselector: '',\n        sentenceselector: '',\n        passagecssclass: 'filterpoodll_pollytextblock_cont',\n        cloudpoodlltoken: '',\n        voice: '',\n        highlightmode: '',\n        theplayer: false,\n        pendingurls: 0,\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        reset: function(){\n            this.unspanify_text_passage();\n            this.textblock = false;\n            this.textstring = false;\n            this.sentenceURLs= [];\n            this.sentencetexts= [];\n            this.wordstarts= [];\n            this.wordcounts= [];\n        },\n\n        set_textblock: function(textblock){\n            var that = this;\n\n            //if we are already set to this textblock, then do nothing\n            if(textblock===this.textblock){\n                log.debug('it was the same textblock');\n                return;\n            }\n            //remove the previous spans if we had them\n            if(this.textblock!==false) {\n                    this.reset();\n            }\n            //set our new textblock\n            this.textblock= textblock;\n            var usetext = textblock.text();\n\n            // Break text into sentences, and fetch data + TTS URL for each sentence.\n            this.spanify_text_passage();\n            this.sentencetexts = this.get_sentences_from_spanified_text();\n            this.pendingurls=this.sentencetexts.length;\n            var previousend = 0;\n\n            for (var currentsentence = 0; currentsentence < this.sentencetexts.length; currentsentence++){\n                this.wordstarts[currentsentence]= previousend;\n                this.wordcounts[currentsentence]= this.split_into_words(this.sentencetexts[currentsentence]).length;\n                previousend = previousend + this.wordcounts[currentsentence];\n\n                var speaktext = this.sentencetexts[currentsentence];\n                this.fetch_polly_url(speaktext,\n                    function(sentenceindex) {\n                        return function(pollyurl) {\n                            that.sentenceURLs[sentenceindex] = pollyurl;\n                            log.debug(sentenceindex + ' ' + pollyurl);\n                            that.pendingurls--;\n                        }\n                    }(currentsentence)\n                );\n            }\n        },\n\n        set_text: function(textstring){\n            var that = this;\n            //if we already have this one, return\n            if(textstring===this.textstring) {\n                log.debug('it was the same textstring');\n                return;\n            }\n            //remove the previous spans if we had them\n            if(this.textblock!==false) {\n                this.reset();\n            }\n\n            //remember this for next time\n            this.textstring= textstring;\n            this.sentencetexts[0]=textstring;\n            this.pendingurls=1;\n            this.fetch_polly_url(textstring,\n                function(pollyurl){\n                    that.sentenceURLs[0] = pollyurl;\n                    log.debug('0' + ' ' + pollyurl);\n                    that.pendingurls--;\n                }\n            );\n\n        },\n\n        init: function (theplayer,itemid, textblock, voice,sentenceselector,wordselector,passagecssclass,highlightmode, cloudpoodlltoken) {\n            var that = this;\n            this.sentenceselector= sentenceselector;\n            this.wordselector= wordselector;\n            this.passagecssclass= passagecssclass;\n            this.cloudpoodlltoken = cloudpoodlltoken;\n            this.highlightmode=highlightmode;\n            this.voice = voice;\n            this.theplayer = theplayer;\n\n            this.set_textblock(textblock);\n\n        },\n\n        // FUNCTION: Split a text passage into sentences.\n        split_into_sentences: function(thetext){\n            thetext = thetext.replace(/\\s+/g,' ').trim();\n            if(thetext ===''){return[];}\n            return thetext.match(/([^\\.!\\?]+[\\.!\\?\"']+)|([^\\.!\\?\"']+$)/g);\n        },\n\n        // FUNCTION: Split a text passage into words.\n        split_into_words: function(thetext){\n            thetext = thetext.replace(/\\s+/g,' ').trim();\n            if(thetext===''){return[];}\n            return thetext.split(' ');\n        },\n\n        // FUNCTION: Fetch polly url.\n        fetch_polly_url: function (speaktext, callback) {\n\n            // The REST API we are calling.\n            var functionname = 'local_cpapi_fetch_polly_url';\n\n            // Fetch the Posturl. We need this.\n            // Set up our ajax request\n            var xhr = new XMLHttpRequest();\n            var that = this;\n\n            // Set up our handler for the response.\n            xhr.onreadystatechange = function (e) {\n                if (this.readyState === 4) {\n                    if (xhr.status === 200) {\n\n                        // Get a yes or forgetit or tryagain.\n                        var payload = xhr.responseText;\n                        var payloadobject = JSON.parse(payload);\n                        if (payloadobject) {\n                            // ReturnCode > 0  indicates an error.\n                            if (payloadobject.returnCode > 0) {\n                                console.log(payloadobject.returnMessage);\n                                return false;\n                                // If all good, then lets do the embed.\n                            } else if (payloadobject.returnCode === 0){\n                                var pollyurl = payloadobject.returnMessage;\n                                callback(pollyurl);\n                            } else {\n                                console.log('Polly Signed URL Request failed:');\n                                console.log(payloadobject);\n                            }\n                        } else {\n                            console.log('Polly Signed URL Request something bad happened');\n                        }\n                    } else {\n                        console.log('Polly Signed URL Request Not 200 response:' + xhr.status);\n                    }\n                }\n            };\n\n            // Make our request.\n            var xhrparams = \"wstoken=\" + this.cloudpoodlltoken\n                    + \"&wsfunction=\" + functionname\n                    + \"&moodlewsrestformat=\" + 'json'\n                    + \"&text=\" + encodeURIComponent(speaktext)\n                    + '&texttype=text'\n                    + '&voice=' + this.voice\n                    + '&appid=' + 'filter_poodll'\n                    + '&owner=poodll'\n                    + '&region=useast1';\n\n            var serverurl = 'https://cloud.poodll.com' + \"/webservice/rest/server.php\";\n            xhr.open(\"POST\", serverurl, true);\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n            xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhr.send(xhrparams);\n        },\n\n        // Is not used.\n        // FUNCTION: Determine if the string is text or HTML.\n        isHTML: function (testString) {\n            var htmlRegex = new RegExp(\"<([A-Za-z][A-Za-z0-9]*)\\\\b[^>]*>(.*?)</\\\\1>\");\n            return htmlRegex.test(testString);\n        },\n\n        unspanify_text_passage: function(){\n\n            //remove select to read class to container\n            this.textblock.removeClass(this.passagecssclass);\n\n           // remove previously set up spans\n            if(this.highlightmode==='word'){\n                this.textblock.find('.tbr_word').contents().unwrap();\n            } else {\n            // For sentences.\n                this.textblock.find('.tbr_sentence').contents().unwrap();\n            }// End of for loop.\n        },\n\n        // FUNCTION: Break a text passage into words/sentences, and surround the words with marker tags.\n        spanify_text_passage: function(){\n            var that = this;\n\n            // The itemcount er.\n            var itemcount = -1;\n\n            //add select to read class to container\n            this.textblock.addClass(this.passagecssclass);\n\n            // Get all the text nodes in the textblock.\n            var textnodes = this.textblock.find('*').contents().filter(function(){ return this.nodeType === 3; });\n            // Wrap sentence or words in text block with spans.\n            textnodes.each(function(){\n                var retpieces = '';\n                if(that.highlightmode==='word'){\n                    //for words\n                    var thewords = that.split_into_words($(this).text());\n                    for (var theword = 0; theword < thewords.length; theword++){\n                        itemcount++;\n                        retpieces =  retpieces + '<span class=\"tbr_word\" data-wordindex=\"'+ itemcount +'\">' + thewords[theword] + '</span> ';\n                    }// End of for loop.\n                } else {\n                    // For sentences.\n                    var thesentences = that.split_into_sentences($(this).text());\n                    for (var thesentence=0; thesentence < thesentences.length; thesentence++){\n                        itemcount++;\n                        retpieces =  retpieces + '<span class=\"tbr_sentence\" data-sentenceindex=\"'+ itemcount +'\">' + thesentences[thesentence] + '</span>&nbsp;';\n                    }// End of for loop.\n                }\n                $(this).replaceWith(retpieces);\n            });// End of textnodes each\n        },\n\n        get_sentences_from_spanified_text: function(){\n            var sentences = [];\n            var spans = this.textblock.find('span.tbr_sentence');\n            spans.each(function(){\n                sentences.push($(this).text());\n            });\n            return sentences\n        },\n\n        // FUNCTION: Unhighlight a sentence as active.\n        dehighlight_all: function(){\n            switch(this.highlightmode){\n                case 'word':\n                    $(this.wordselector,this.textblock).removeClass('activesentence');\n                    break;\n                case 'sentence':\n                    $(this.sentenceselector).removeClass('activesentence');\n                    break;\n                case 'none':\n                default:\n                // Do nothing.\n            }\n        },\n\n        // FUNCTION: Highlight a sentence as active.\n        highlight_sentence: function(thesentence_index){\n            switch(this.highlightmode){\n                case 'word':\n                    $(this.wordselector,this.textblock).removeClass('activesentence');\n                    $(this.wordselector,this.textblock).slice(this.wordstarts[thesentence_index],\n                            this.wordstarts[thesentence_index] +\n                            this.wordcounts[thesentence_index]).addClass('activesentence');\n                    break;\n                case 'sentence':\n                    $(this.sentenceselector).removeClass('activesentence');\n                    $(this.sentenceselector + '[data-sentenceindex=' + thesentence_index + ']').addClass('activesentence');\n                    break;\n                case 'none':\n                default:\n                // Do nothing.\n            }\n        },\n\n        // FUNCTION: Play a single sentence and mark it active for display purposes.\n        doplayaudio: function(thesentence) {\n            var that=this;\n            if(this.pendingurls>0){\n                setTimeout(function(){that.doplayaudio(thesentence);},100);\n                return;\n            }\n            if (typeof thesentence === 'number') {\n                // If thesentence is a number.\n                this.dehighlight_all();\n                this.highlight_sentence(thesentence);\n                this.theplayer.attr('src', this.sentenceURLs[thesentence]);\n            //    log.debug('sentenceurl:' + this.sentenceURLs[thesentence]);\n            //    log.debug('sentencenumber:' + thesentence);\n            //    log.debug('sentencetext:' + this.sentencetexts[thesentence]);\n            } else {\n                if(this.sentenceURLs.length > 0) {\n                    this.theplayer.attr('src', this.sentenceURLs[0]);\n                }\n            }\n            this.theplayer[0].load();\n            this.theplayer[0].play();\n        }\n    }\n});"],"file":"pollyhelper.min.js"}