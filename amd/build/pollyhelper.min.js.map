{"version":3,"sources":["../src/pollyhelper.js"],"names":["define","$","log","debug","sentenceURLs","wordstarts","wordcounts","textblock","wordselector","sentenceselector","cloudpoodlltoken","voice","highlightmode","theplayer","clone","extend","init","itemid","that","usetext","text","spanify_text_passage","sentences","split_into_sentences","previousend","currentsentence","length","split_into_words","speaktext","fetch_polly_url","sentenceindex","pollyurl","thetext","replace","trim","match","split","callback","xhr","XMLHttpRequest","onreadystatechange","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","console","returnMessage","xhrparams","encodeURIComponent","open","setRequestHeader","send","isHTML","testString","test","itemcount","textnodes","find","contents","filter","nodeType","each","retpieces","thewords","theword","thesentences","thesentence","replaceWith","dehighlight_all","removeClass","highlight_sentence","thesentence_index","slice","addClass","doplayaudio","attr","load","play"],"mappings":"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","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('Polly Url: initialising');\n\n    return {\n        sentenceURLs: [],\n        wordstarts: [],\n        wordcounts: [],\n        textblock: false,\n        wordselector: '',\n        sentenceselector: '',\n        cloudpoodlltoken: '',\n        voice: '',\n        highlightmode: '',\n        theplayer: false,\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function (theplayer,itemid, textblock, voice,sentenceselector,wordselector,highlightmode, cloudpoodlltoken) {\n            var that = this;\n            var usetext = textblock.text();\n            this.textblock= textblock;\n            this.sentenceselector= sentenceselector;\n            this.wordselector= wordselector;\n            this.cloudpoodlltoken = cloudpoodlltoken;\n            this.highlightmode=highlightmode;\n            this.voice = voice;\n            this.theplayer = theplayer;\n\n            // Break text into sentences, and fetch data + TTS URL for each sentence.\n            this.spanify_text_passage();\n            var sentences = this.split_into_sentences(usetext);\n            var previousend = 0;\n\n            for (var currentsentence = 0; currentsentence < sentences.length; currentsentence++){\n                this.wordstarts[currentsentence]= previousend;\n                this.wordcounts[currentsentence]= this.split_into_words(sentences[currentsentence]).length;\n                previousend = previousend + this.wordcounts[currentsentence];\n\n                var speaktext = sentences[currentsentence];\n                this.fetch_polly_url(speaktext,\n                    function(sentenceindex) {\n                        return function(pollyurl) {\n                            that.sentenceURLs[sentenceindex] = pollyurl;\n                        }\n                    }(currentsentence)\n                );\n            }\n        },\n\n        // FUNCTION: Split a text passage into sentences.\n        split_into_sentences: function(thetext){\n            thetext = thetext.replace(/\\s+/g,' ').trim();\n            if(thetext ===''){return[];}\n            return thetext.match(/([^\\.!\\?]+[\\.!\\?\"']+)|([^\\.!\\?\"']+$)/g);\n        },\n\n        // FUNCTION: Split a text passage into words.\n        split_into_words: function(thetext){\n            thetext = thetext.replace(/\\s+/g,' ').trim();\n            if(thetext===''){return[];}\n            return thetext.split(' ');\n        },\n\n        // FUNCTION: Fetch polly url.\n        fetch_polly_url: function (speaktext, callback) {\n\n            // The REST API we are calling.\n            var functionname = 'local_cpapi_fetch_polly_url';\n\n            // Fetch the Posturl. We need this.\n            // Set up our ajax request\n            var xhr = new XMLHttpRequest();\n            var that = this;\n\n            // Set up our handler for the response.\n            xhr.onreadystatechange = function (e) {\n                if (this.readyState === 4) {\n                    if (xhr.status === 200) {\n\n                        // Get a yes or forgetit or tryagain.\n                        var payload = xhr.responseText;\n                        var payloadobject = JSON.parse(payload);\n                        if (payloadobject) {\n                            // ReturnCode > 0  indicates an error.\n                            if (payloadobject.returnCode > 0) {\n                                console.log(payloadobject.returnMessage);\n                                return false;\n                                // If all good, then lets do the embed.\n                            } else if (payloadobject.returnCode === 0){\n                                var pollyurl = payloadobject.returnMessage;\n                                callback(pollyurl);\n                            } else {\n                                console.log('Polly Signed URL Request failed:');\n                                console.log(payloadobject);\n                            }\n                        } else {\n                            console.log('Polly Signed URL Request something bad happened');\n                        }\n                    } else {\n                        console.log('Polly Signed URL Request Not 200 response:' + xhr.status);\n                    }\n                }\n            };\n\n            // Make our request.\n            var xhrparams = \"wstoken=\" + this.cloudpoodlltoken\n                    + \"&wsfunction=\" + functionname\n                    + \"&moodlewsrestformat=\" + 'json'\n                    + \"&text=\" + encodeURIComponent(speaktext)\n                    + '&texttype=text'\n                    + '&voice=' + this.voice\n                    + '&appid=' + 'filter_poodll'\n                    + '&owner=poodll'\n                    + '&region=useast1';\n\n            var serverurl = 'https://cloud.poodll.com' + \"/webservice/rest/server.php\";\n            xhr.open(\"POST\", serverurl, true);\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n            xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhr.send(xhrparams);\n        },\n\n        // Is not used.\n        // FUNCTION: Determine if the string is text or HTML.\n        isHTML: function (testString) {\n            var htmlRegex = new RegExp(\"<([A-Za-z][A-Za-z0-9]*)\\\\b[^>]*>(.*?)</\\\\1>\");\n            return htmlRegex.test(testString);\n        },\n\n        // FUNCTION: Break a text passage into words/sentences, and surround the words with marker tags.\n        spanify_text_passage: function(){\n            var that = this;\n\n            // The itemcount er.\n            var itemcount = -1;\n\n            // Get all the text nodes in the textblock.\n            var textnodes = this.textblock.find('*').contents().filter(function(){ return this.nodeType === 3; });\n            // Wrap sentence or words in text block with spans.\n            textnodes.each(function(){\n                var retpieces = '';\n                if(that.highlightmode==='word'){\n                    //for words\n                    var thewords = that.split_into_words($(this).text());\n                    for (var theword = 0; theword < thewords.length; theword++){\n                        itemcount++;\n                        retpieces =  retpieces + '<span class=\"tbr_word\" data-wordindex=\"'+ itemcount +'\">' + thewords[theword] + '</span> ';\n                    }// End of for loop.\n                } else {\n                    // For sentences.\n                    var thesentences = that.split_into_sentences($(this).text());\n                    for (var thesentence=0; thesentence < thesentences.length; thesentence++){\n                        itemcount++;\n                        retpieces =  retpieces + '<span class=\"tbr_sentence\" data-sentenceindex=\"'+ itemcount +'\">' + thesentences[thesentence] + '</span>&nbsp;';\n                    }// End of for loop.\n                }\n                $(this).replaceWith(retpieces);\n            });// End of textnodes each\n        },\n\n        // FUNCTION: Unhighlight a sentence as active.\n        dehighlight_all: function(){\n            switch(this.highlightmode){\n                case 'word':\n                    $(this.wordselector,this.textblock).removeClass('activesentence');\n                    break;\n                case 'sentence':\n                    $(this.sentenceselector).removeClass('activesentence');\n                    break;\n                case 'none':\n                default:\n                // Do nothing.\n            }\n        },\n\n        // FUNCTION: Highlight a sentence as active.\n        highlight_sentence: function(thesentence_index){\n            switch(this.highlightmode){\n                case 'word':\n                    $(this.wordselector,this.textblock).removeClass('activesentence');\n                    $(this.wordselector,this.textblock).slice(this.wordstarts[thesentence_index],\n                            this.wordstarts[thesentence_index] +\n                            this.wordcounts[thesentence_index]).addClass('activesentence');\n                    break;\n                case 'sentence':\n                    $(this.sentenceselector).removeClass('activesentence');\n                    $(this.sentenceselector + '[data-sentenceindex=' + thesentence_index + ']').addClass('activesentence');\n                    break;\n                case 'none':\n                default:\n                // Do nothing.\n            }\n        },\n\n        // FUNCTION: Play a single sentence and mark it active for display purposes.\n        doplayaudio: function(thesentence){\n            this.dehighlight_all();\n            this.highlight_sentence(thesentence);\n            this.theplayer.attr('src',this.sentenceURLs[thesentence]);\n            this.theplayer[0].load();\n            this.theplayer[0].play();\n        },\n    }\n});"],"file":"pollyhelper.min.js"}