define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/MediaStreamRecorder","filter_poodll/gumadapter","filter_poodll/uploader","filter_poodll/timer","filter_poodll/poodll_basemediaskin","filter_poodll/poodll_burntrosemediaskin"],function(a,b,c,d,e,f,g,h,i){"use strict";return b.debug("PoodLL Media Recorder: initialising"),{instanceprops:[],skins:[],fetch_instanceprops:function(a){return this.instanceprops[a]},fetch_skin:function(a){return this.skins[a]},supports_current_browser:function(a){if("audio"!=a.mediatype&&"video"!=a.mediatype)return!1;var c=0==M.cfg.wwwroot.indexOf("https:")||0==M.cfg.wwwroot.indexOf("http://localhost");if(c&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var d=!1;switch(a.mediatype){case"audio":d=!0;break;case"video":var e=!(navigator.userAgent.indexOf("Edge")===-1||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob);e||(d=!0)}return d&&b.debug("PoodLL Media Recorder: supports this browser"),d}return!1},embed:function(a,b){var c="filter_poodll_controlbar_"+b.widgetid;this.init_instance_props(c);var d=this.fetch_instanceprops(c);d.config=b,d.timeinterval=b.media_timeinterval,d.audiomimetype=b.media_audiomimetype,d.videorecordertype=b.media_videorecordertype,d.videocaptureheight=b.media_videocaptureheight;var e=this.init_skin(c,d.config.media_skin,d);switch(d.config.onuploadsuccess=this.on_upload_success,d.config.onuploadfailure=this.on_upload_failure,b.mediatype){case"audio":var h=e.fetch_audio_preview(b.media_skin);d.controlbar=this.insert_fetch_control_bar_audio(a,c,h),d.uploader=f.clone(),d.uploader.init(a,b),this.register_audio_events(c);break;case"video":var h=e.fetch_video_preview(b.media_skin);d.controlbar=this.insert_fetch_control_bar_video(a,c,h),d.uploader=f.clone(),d.uploader.init(a,b),this.register_video_events(c)}d.timer=g.clone(),d.timer.init(0,function(){d.controlbar.status.html(d.timer.fetch_display_time())})},init_instance_props:function(a){this.instanceprops[a]={},this.instanceprops[a].recorded_index=0,this.instanceprops[a].mediaRecorder=null,this.instanceprops[a].blobs=[],this.instanceprops[a].timeinterval=5e3,this.instanceprops[a].audiomimetype="audio/webm",this.instanceprops[a].videorecordertype="auto",this.instanceprops[a].videocapturewidth=320,this.instanceprops[a].videocaptureheight=240,this.instanceprops[a].controlbar="",this.instanceprops[a].previewvolume=1,this.instanceprops[a].timer={},this.instanceprops[a].uploader={},this.instanceprops[a].uploaded=!1},init_skin:function(a,b,c){switch(b){case"burntrose":this.skins[a]=i.clone();break;case"plain":case"standard":default:this.skins[a]=h.clone()}return this.skins[a].init(c,this),this.skins[a]},on_upload_success:function(a){b.debug("from poodllmediarecorder: uploadsuccess");var c="filter_poodll_controlbar_"+a;this.skins[c].on_upload_success(c)},on_upload_failure:function(a){b.debug("from poodllmediarecorder: uploadfailure"),this.skins[a].on_upload_failure(a)},onMediaError:function(a){console.error("media error",a)},captureUserMedia:function(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},do_start_audio:function(a,b,c){a.blobs=[],this.captureUserMedia(b,c,this.onMediaError)},do_start_video:function(a,b){},do_play_audio:function(a,d){if(a.blobs&&a.blobs.length>0)switch(b.debug("playing type:"+a.blobs[0].type),a.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(a.blobs,function(b){var c=URL.createObjectURL(b);d.src=c,d.controls=!0,d.volume=a.previewvolume,d.play()});break;case"video/webm":case"audio/ogg":case"audio/webm":default:var e=c.simpleConcatenateBlobs(a.blobs,a.blobs[0].type),f=URL.createObjectURL(e);d.src=f,d.controls=!0,d.volume=a.previewvolume,d.play();break;case"olddefault":c.concatenateBlobs(a.blobs,a.blobs[0].type,function(b){var c=URL.createObjectURL(b);d.src=c,d.controls=!0,d.volume=a.previewvolume,d.play()})}},do_play_video:function(a){},do_save_audio:function(a){if(a.blobs&&a.blobs.length>0){switch(a.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(a.blobs,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)});break;case"audio/ogg":case"audio/webm":case"video/webm":default:var b=c.simpleConcatenateBlobs(a.blobs,a.blobs[0].type);a.uploader.uploadBlob(b,a.blobs[0].type);break;case"old default":c.concatenateBlobs(a.blobs,a.blobs[0].type,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)})}a.uploaded=!0,a.controlbar.startbutton.attr("disabled",!0)}},do_save_video:function(a){},do_stop_audio:function(a){a.mediaRecorder.stop()},do_stop_video:function(a){},do_pause_audio:function(a){a.mediaRecorder.resume(),a.mediaRecorder.pause()},do_pause_video:function(a){},do_resume_audio:function(a){a.mediaRecorder.resume()},do_resume_video:function(a){},register_audio_events:function(a){var c=this.fetch_instanceprops(a),d=this.skins[a],e={audio:!0},f=function(e){b.debug("onmediasuccess"),c.mediaRecorder=new MediaStreamRecorder(e),c.mediaRecorder.mimeType=c.audiomimetype,c.mediaRecorder.audioChannels=1,c.mediaRecorder.start(c.timeinterval),b.debug(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){b.debug("we got blob"),c.blobs.push(a)},d.skin_onMediaSuccessAudio(a)};d.register_controlbar_events_audio(f,e,a)},register_video_events:function(a){var c=this.fetch_instanceprops(a),d={audio:!IsOpera&&!IsEdge,video:!0},e=function(d){c.mediaRecorder=new MediaStreamRecorder(d),c.controlbar.preview.attr("src",window.URL.createObjectURL(d)),c.controlbar.preview.attr("controls",!1),c.controlbar.preview.get(0).volume=0,c.controlbar.preview.get(0).play(),"mediarec"===c.videorecordertype&&(c.mediaRecorder.recorderType=MediaRecorderWrapper),"webp"===c.videorecordertype&&(c.mediaRecorder.recorderType=WhammyRecorder),c.mediaRecorder.videoWidth=c.videocapturewidth,c.mediaRecorder.videoHeight=c.videocaptureheight,c.mediaRecorder.start(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a),b.debug("We got a blobby")},skin.skin_onMediaSuccessVideo(a)};skin.register_controlbar_events(e,d,a)},update_status:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},insert_fetch_control_bar_audio:function(a,b,c){var d=(this.fetch_instanceprops(b),this.fetch_skin(b)),e=d.insert_fetch_control_bar_audio(a,b,c);return e},insert_fetch_control_bar_video:function(a,b,c){var d=(this.fetch_instanceprops(b),this.fetch_skin(b)),e=d.insert_fetch_control_bar_video(a,b,c);return e}}});