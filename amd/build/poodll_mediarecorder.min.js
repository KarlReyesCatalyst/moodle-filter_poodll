define(["jquery","core/log","filter_poodll/MediaStreamRecorder","filter_poodll/gumadapter","filter_poodll/uploader","filter_poodll/timer"],function(a,b,c,d,e,f){"use strict";return b.debug("PoodLL Media Recorder: initialising"),{recorded_index:0,mediaRecorder:null,blobs:[],controlbarid:"",timeinterval:5e3,audiomimetype:"audio/webm",videorecordertype:"auto",videocapturewidth:320,videocaptureheight:240,controlbar:"",previewvolume:1,uploaded:!1,supports_current_browser:function(a){return"audio"!=a.mediatype&&"video"!=a.mediatype?!1:0==M.cfg.wwwroot.indexOf("https:")&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(b.debug("PoodLL Media Recorder: supports this browser"),!0):!1},embed:function(a,b){this.config=b,this.timeinterval=b.media_timeinterval,this.audiomimetype=b.media_audiomimetype,this.videorecordertype=b.media_videorecordertype,this.videocapturewidth=b.media_videocapturewidth,this.videocaptureheight=b.media_videocaptureheight;var c="filter_poodll_controlbar_"+b.widgetid;switch(b.mediatype){case"audio":var d=this.fetch_audio_preview();this.controlbar=this.insert_fetch_control_bar(a,c,d),e.init(a,b),this.register_audio_events();break;case"video":var d=this.fetch_video_preview();this.controlbar=this.insert_fetch_control_bar(a,c,d),e.init(a,b),this.register_video_events()}var g=this.controlbar;f.init(0,function(){g.status.html(f.fetch_display_time())})},insert_fetch_control_bar:function(b,c,d){var e='<div class="poodll_mediarecorderbox" id="'+c+'">',f=this.fetch_status_bar();e+=f,e+=d,e+='<button type="button" class="poodll_start-recording">'+M.util.get_string("recui_record","filter_poodll")+"</button>",e+='<button type="button" class="poodll_stop-recording" disabled>'+M.util.get_string("recui_stop","filter_poodll")+"</button>",e+='<button type="button" class="poodll_pause-recording" disabled>'+M.util.get_string("recui_pause","filter_poodll")+"</button>",e+=' <button type="button" class="poodll_resume-recording hide" disabled>'+M.util.get_string("recui_continue","filter_poodll")+"</button>",e+=' <button type="button" class="poodll_play-recording" disabled>'+M.util.get_string("recui_play","filter_poodll")+"</button>",e+='<button type="button" class="poodll_save-recording" disabled>'+M.util.get_string("recui_save","filter_poodll")+"</button>",e+="</div>",a(b).prepend(e);var g={status:a("#"+c+" > .poodll_status"),preview:a("#"+c+" > .poodll_preview"),startbutton:a("#"+c+" > .poodll_start-recording"),stopbutton:a("#"+c+" > .poodll_stop-recording"),pausebutton:a("#"+c+" > .poodll_pause-recording"),resumebutton:a("#"+c+" > .poodll_resume-recording"),playbutton:a("#"+c+" > .poodll_play-recording"),savebutton:a("#"+c+" > .poodll_save-recording")};return g},fetch_status_bar:function(){var a='<div class="poodll_status" width="320" height="50">00:00:00</div>';return a},fetch_audio_preview:function(){var a='<audio class="poodll_preview hide" controls></audio>';return a},fetch_video_preview:function(){var a='<video class="poodll_preview" width="320" height="240"></video>';return a},onMediaError:function(a){console.error("media error",a)},captureUserMedia:function(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},bytesToSize:function(a){var b=1e3,c=["Bytes","KB","MB","GB","TB"];if(0===a)return"0 Bytes";var d=parseInt(Math.floor(Math.log(a)/Math.log(b)),10);return(a/Math.pow(b,d)).toPrecision(3)+" "+c[d]},getTimeLength:function(a){var b=new Date(a);return b.getUTCHours()+" hours, "+b.getUTCMinutes()+" minutes and "+b.getUTCSeconds()+" second(s)"},register_controlbar_events:function(b,c){var d=this;this.controlbar.startbutton.click(function(){this.disabled=!0,d.blobs=[],d.captureUserMedia(c,b,d.onMediaError),d.controlbar.playbutton.attr("disabled",!0),d.controlbar.resumebutton.hide(),d.controlbar.pausebutton.show(),d.controlbar.pausebutton.attr("disabled",!1),d.set_visual_mode("recordmode",d),f.reset(),f.start(),d.update_status()}),this.controlbar.stopbutton.click(function(){this.disabled=!0,d.mediaRecorder.stop();var a=d.controlbar.preview;a&&a.get(0)&&a.get(0).pause(),d.set_visual_mode("previewmode",d),f.stop(),d.update_status(),d.controlbar.playbutton.attr("disabled",!1),d.controlbar.pausebutton.attr("disabled",!0),d.uploaded||d.controlbar.startbutton.attr("disabled",!1),d.controlbar.resumebutton.hide(),d.controlbar.pausebutton.show()}),this.controlbar.pausebutton.click(function(){this.disabled=!0,a(this).hide(),d.controlbar.resumebutton.show(),d.mediaRecorder.resume(),d.mediaRecorder.pause(),d.controlbar.resumebutton.attr("disabled",!1),d.set_visual_mode("pausedmode",d),f.pause(),d.update_status()}),this.controlbar.resumebutton.click(function(){this.disabled=!0,a(this).hide(),d.controlbar.pausebutton.show(),d.mediaRecorder.resume(),d.controlbar.pausebutton.attr("disabled",!1),d.set_visual_mode("recordmode",d),f.resume(),d.update_status()}),this.controlbar.playbutton.click(function(){this.disabled=!0;var a=d.controlbar.preview.get(0);d.blobs&&d.blobs.length>0&&ConcatenateBlobs(d.blobs,d.blobs[0].type,function(b){var c=URL.createObjectURL(b);a.src=c,a.controls=!0,a.volume=d.previewvolume,a.play()}),d.controlbar.stopbutton.attr("disabled",!1),d.controlbar.startbutton.attr("disabled",!0)}),this.controlbar.savebutton.click(function(){return this.disabled=!0,d.blobs&&d.blobs.length>0?ConcatenateBlobs(d.blobs,d.blobs[0].type,function(a){e.uploadBlob(a,d.blobs[0].type),d.controlbar.startbutton.attr("disabled",!0),d.uploaded=!0}):e.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll")),!1}),window.onbeforeunload=function(){d.controlbar.startbutton.attr("disabled",!1);var a=d.controlbar.preview;a&&a.get(0)&&a.get(0).pause()}},register_audio_events:function(){var a={audio:!0},c=this,d=function(a){b.debug("onmediasuccess"),c.mediaRecorder=new MediaStreamRecorder(a),c.mediaRecorder.mimeType=c.audiomimetype,c.mediaRecorder.audioChannels=1,c.mediaRecorder.start(c.timeInterval),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a)},c.controlbar.preview.attr("src",null),c.controlbar.stopbutton.attr("disabled",!1),c.controlbar.pausebutton.attr("disabled",!1),c.controlbar.savebutton.attr("disabled",!1)};this.register_controlbar_events(d,a)},register_video_events:function(){var a={audio:!IsOpera&&!IsEdge,video:!0},b=this,c=function(a){b.mediaRecorder=new MediaStreamRecorder(a),b.controlbar.preview.attr("src",window.URL.createObjectURL(a)),b.controlbar.preview.attr("controls",!1),b.controlbar.preview.get(0).volume=0,b.controlbar.preview.get(0).play(),"mediarec"===b.videorecordertype&&(b.mediaRecorder.recorderType=MediaRecorderWrapper),"webp"===b.videorecordertype&&(b.mediaRecorder.recorderType=WhammyRecorder),b.mediaRecorder.videoWidth=b.videocapturewidth,b.mediaRecorder.videoHeight=b.videocaptureheight,b.mediaRecorder.start(b.timeInterval),b.mediaRecorder.ondataavailable=function(a){b.blobs.push(a)},b.controlbar.stopbutton.attr("disabled",!1),b.controlbar.pausebutton.attr("disabled",!1),b.controlbar.savebutton.attr("disabled",!1)};this.register_controlbar_events(c,a)},set_visual_mode:function(a,b){switch(a){case"recordmode":b.controlbar.preview.addClass("poodll_recording"),b.controlbar.status.addClass("poodll_recording"),"audio"==b.config.mediatype&&b.controlbar.preview.addClass("hide"),b.controlbar.status.removeClass("hide");break;case"previewmode":b.controlbar.preview.removeClass("poodll_recording"),b.controlbar.status.removeClass("poodll_recording"),"audio"==b.config.mediatype&&b.controlbar.preview.removeClass("hide"),b.controlbar.status.addClass("hide");break;case"pausedmode":b.controlbar.preview.removeClass("poodll_recording"),b.controlbar.status.removeClass("poodll_recording")}},update_status:function(){this.controlbar.status.html(f.fetch_display_time())}}});