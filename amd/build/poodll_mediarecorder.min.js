define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/MediaStreamRecorder","filter_poodll/gumadapter","filter_poodll/uploader","filter_poodll/timer"],function(a,b,c,d,e,f,g){"use strict";return b.debug("PoodLL Media Recorder: initialising"),{instanceprops:[],fetch_instanceprops:function(a){return this.instanceprops[a]},supports_current_browser:function(a){if("audio"!=a.mediatype&&"video"!=a.mediatype)return!1;if(0==M.cfg.wwwroot.indexOf("https:")&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var c=!1;switch(a.mediatype){case"audio":c=!0;break;case"video":var d=!(-1===navigator.userAgent.indexOf("Edge")||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob);d||(c=!0)}return c&&b.debug("PoodLL Media Recorder: supports this browser"),c}return!1},embed:function(a,b){var c="filter_poodll_controlbar_"+b.widgetid;this.init_instance_props(c);var d=this.fetch_instanceprops(c);switch(d.config=b,d.timeinterval=b.media_timeinterval,d.audiomimetype=b.media_audiomimetype,d.videorecordertype=b.media_videorecordertype,d.videocaptureheight=b.media_videocaptureheight,d.config.onuploadsuccess=this.on_upload_success,d.config.onuploadfailure=this.on_upload_failure,b.mediatype){case"audio":var e=this.fetch_audio_preview(b.media_skin);d.controlbar=this.insert_fetch_control_bar(a,c,e),d.uploader=f.clone(),d.uploader.init(a,b),this.register_audio_events(c);break;case"video":var e=this.fetch_video_preview(b.media_skin);d.controlbar=this.insert_fetch_control_bar_video(a,c,e),d.uploader=f.clone(),d.uploader.init(a,b),this.register_video_events(c)}d.timer=g.clone(),d.timer.init(0,function(){d.controlbar.status.html(d.timer.fetch_display_time())})},init_instance_props:function(a){this.instanceprops[a]={},this.instanceprops[a].recorded_index=0,this.instanceprops[a].mediaRecorder=null,this.instanceprops[a].blobs=[],this.instanceprops[a].timeinterval=5e3,this.instanceprops[a].audiomimetype="audio/webm",this.instanceprops[a].videorecordertype="auto",this.instanceprops[a].videocapturewidth=320,this.instanceprops[a].videocaptureheight=240,this.instanceprops[a].controlbar="",this.instanceprops[a].previewvolume=1,this.instanceprops[a].timer={},this.instanceprops[a].uploader={},this.instanceprops[a].uploaded=!1},on_upload_success:function(c){b.debug("from poodllmediarecorder: uploadsuccess");var d="filter_poodll_controlbar_"+c;a("#"+d+" > .poodll_save-recording").hide(),a("#"+d+" > .poodll_savedsuccessfully").show()},on_upload_failure:function(a){b.debug("from poodllmediarecorder: uploadfailure")},fetch_status_bar:function(a){var b='<div class="poodll_status_'+a+'" width="320" height="50">00:00:00</div>';return b},fetch_audio_preview:function(a){var b='<audio class="poodll_preview_'+a+' hide" controls></audio>';return b},fetch_video_preview:function(a){var b='<video class="poodll_preview_'+a+'" width="320" height="240"></video>';return b},onMediaError:function(a){console.error("media error",a)},captureUserMedia:function(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},bytesToSize:function(a){var b=1e3,c=["Bytes","KB","MB","GB","TB"];if(0===a)return"0 Bytes";var d=parseInt(Math.floor(Math.log(a)/Math.log(b)),10);return(a/Math.pow(b,d)).toPrecision(3)+" "+c[d]},getTimeLength:function(a){var b=new Date(a);return b.getUTCHours()+" hours, "+b.getUTCMinutes()+" minutes and "+b.getUTCSeconds()+" second(s)"},register_audio_events:function(a){var c=this.fetch_instanceprops(a),d={audio:!0},e=function(a){b.debug("onmediasuccess"),c.mediaRecorder=new MediaStreamRecorder(a),c.mediaRecorder.mimeType=c.audiomimetype,c.mediaRecorder.audioChannels=1,c.mediaRecorder.start(c.timeinterval),b.debug(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){b.debug("we got blob"),c.blobs.push(a)},c.controlbar.preview.attr("src",null),c.controlbar.stopbutton.attr("disabled",!1),c.controlbar.pausebutton.attr("disabled",!1),c.controlbar.savebutton.attr("disabled",!1)};this.register_controlbar_events(e,d,a)},register_video_events:function(a){var c=this.fetch_instanceprops(a),d={audio:!IsOpera&&!IsEdge,video:!0},e=function(a){c.mediaRecorder=new MediaStreamRecorder(a),c.controlbar.preview.attr("src",window.URL.createObjectURL(a)),c.controlbar.preview.attr("controls",!1),c.controlbar.preview.get(0).volume=0,c.controlbar.preview.get(0).play(),"mediarec"===c.videorecordertype&&(c.mediaRecorder.recorderType=MediaRecorderWrapper),"webp"===c.videorecordertype&&(c.mediaRecorder.recorderType=WhammyRecorder),c.mediaRecorder.videoWidth=c.videocapturewidth,c.mediaRecorder.videoHeight=c.videocaptureheight,c.mediaRecorder.start(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a),b.debug("We got a blobby")},c.controlbar.stopbutton.attr("disabled",!1),c.controlbar.pausebutton.attr("disabled",!1),c.controlbar.savebutton.attr("disabled",!1)};this.register_controlbar_events(e,d,a)},update_status:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},set_visual_mode:function(a,b){var c=this.fetch_instanceprops(b);switch(c.config.media_skin){case"standard":this.set_visual_mode_standard(a,b);break;case"burntrose":this.set_visual_mode_burntrose(a,b)}},register_controlbar_events:function(a,b,c){var d=this.fetch_instanceprops(c);switch(d.config.media_skin){case"standard":this.register_controlbar_events_standard(a,b,c);break;case"burntrose":this.register_controlbar_events_burntrose(a,b,c)}},insert_fetch_control_bar:function(a,b,c){var d=this.fetch_instanceprops(b),e="";switch(d.config.media_skin){case"standard":e=this.insert_fetch_control_bar_standard(a,b,c);break;case"burntrose":e=this.insert_fetch_control_bar_burntrose(a,b,c)}return e},insert_fetch_control_bar_video:function(a,b,c){var d=this.fetch_instanceprops(b),e="";switch(d.config.media_skin){case"standard":e=this.insert_fetch_control_bar_standard(a,b,c);break;case"burntrose":e=this.insert_fetch_control_bar_video_burntrose(a,b,c)}return e},set_visual_mode_standard:function(a,b){var c=this.fetch_instanceprops(b);switch(a){case"recordmode":c.controlbar.preview.addClass("poodll_recording"),c.controlbar.status.addClass("poodll_recording"),"audio"==c.config.mediatype&&c.controlbar.preview.addClass("hide"),c.controlbar.status.removeClass("hide");break;case"previewmode":c.controlbar.preview.removeClass("poodll_recording"),c.controlbar.status.removeClass("poodll_recording"),"audio"==c.config.mediatype&&c.controlbar.preview.removeClass("hide"),c.controlbar.status.addClass("hide");break;case"pausedmode":c.controlbar.preview.removeClass("poodll_recording"),c.controlbar.status.removeClass("poodll_recording")}},insert_fetch_control_bar_standard:function(b,c,d){var e='<div class="poodll_mediarecorderbox_standard" id="'+c+'">',f=this.fetch_status_bar("standard");e+=f,e+=d,e+='<button type="button" class="poodll_mediarecorder_button_standard poodll_start-recording_standard">'+M.util.get_string("recui_record","filter_poodll")+"</button>",e+='<button type="button" class="poodll_mediarecorder_button_standard poodll_stop-recording_standard" disabled>'+M.util.get_string("recui_stop","filter_poodll")+"</button>",e+='<button type="button" class="poodll_mediarecorder_button_standard poodll_pause-recording_standard" disabled>'+M.util.get_string("recui_pause","filter_poodll")+"</button>",e+=' <button type="button" class="poodll_mediarecorder_button_standard poodll_resume-recording_standard hide" disabled>'+M.util.get_string("recui_continue","filter_poodll")+"</button>",e+=' <button type="button" class="poodll_mediarecorder_button_standard poodll_play-recording_standard" disabled>'+M.util.get_string("recui_play","filter_poodll")+"</button>",e+='<button type="button" class="poodll_save-recording_standard" disabled>'+M.util.get_string("recui_save","filter_poodll")+"</button>",e+="</div>",a(b).prepend(e);var g={status:a("#"+c+" > .poodll_status_standard"),preview:a("#"+c+" > .poodll_preview_standard"),startbutton:a("#"+c+" > .poodll_start-recording_standard"),stopbutton:a("#"+c+" > .poodll_stop-recording_standard"),pausebutton:a("#"+c+" > .poodll_pause-recording_standard"),resumebutton:a("#"+c+" > .poodll_resume-recording_standard"),playbutton:a("#"+c+" > .poodll_play-recording_standard"),savebutton:a("#"+c+" > .poodll_save-recording_standard")};return g},register_controlbar_events_standard:function(d,e,f){var g=this,h=this.fetch_instanceprops(f);h.controlbar.startbutton.click(function(){a("#"+h.config.widgetid+"_messages").text(""),this.disabled=!0,h.blobs=[],g.captureUserMedia(e,d,g.onMediaError),h.controlbar.playbutton.attr("disabled",!0),h.controlbar.resumebutton.hide(),h.controlbar.pausebutton.show(),h.controlbar.pausebutton.attr("disabled",!1),g.set_visual_mode("recordmode",f),h.timer.reset(),h.timer.start(),g.update_status(f)}),h.controlbar.stopbutton.click(function(){this.disabled=!0,h.mediaRecorder.stop();var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause(),g.set_visual_mode("previewmode",f),h.timer.stop(),g.update_status(f),h.controlbar.playbutton.attr("disabled",!1),h.controlbar.pausebutton.attr("disabled",!0),h.uploaded||h.controlbar.startbutton.attr("disabled",!1),h.controlbar.resumebutton.hide(),h.controlbar.pausebutton.show()}),h.controlbar.pausebutton.click(function(){this.disabled=!0,a(this).hide(),h.controlbar.resumebutton.show(),h.mediaRecorder.resume(),h.mediaRecorder.pause(),h.controlbar.resumebutton.attr("disabled",!1),g.set_visual_mode("pausedmode",f),h.timer.pause(),g.update_status(f)}),h.controlbar.resumebutton.click(function(){this.disabled=!0,a(this).hide(),h.controlbar.pausebutton.show(),h.mediaRecorder.resume(),h.controlbar.pausebutton.attr("disabled",!1),g.set_visual_mode("recordmode",f),h.timer.resume(),g.update_status(f)}),h.controlbar.playbutton.click(function(){this.disabled=!0;var a=h.controlbar.preview.get(0);if(h.blobs&&h.blobs.length>0)switch(b.debug("playing type:"+h.blobs[0].type),h.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(h.blobs,function(b){var c=URL.createObjectURL(b);a.src=c,a.controls=!0,a.volume=h.previewvolume,a.play()});break;case"video/webm":case"audio/ogg":case"audio/webm":default:var d=c.simpleConcatenateBlobs(h.blobs,h.blobs[0].type),e=URL.createObjectURL(d);a.src=e,a.controls=!0,a.volume=h.previewvolume,a.play();break;case"olddefault":c.concatenateBlobs(h.blobs,h.blobs[0].type,function(b){var c=URL.createObjectURL(b);a.src=c,a.controls=!0,a.volume=h.previewvolume,a.play()})}h.controlbar.stopbutton.attr("disabled",!1),h.controlbar.startbutton.attr("disabled",!0)}),h.controlbar.savebutton.click(function(){if(this.disabled=!0,h.blobs&&h.blobs.length>0)switch(h.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(h.blobs,function(a){h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0});break;case"audio/ogg":case"audio/webm":case"video/webm":default:var a=c.simpleConcatenateBlobs(h.blobs,h.blobs[0].type);h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0;break;case"old default":c.concatenateBlobs(h.blobs,h.blobs[0].type,function(a){h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0})}else h.uploader.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll"));return!1}),window.onbeforeunload=function(){h.controlbar.startbutton.attr("disabled",!1);var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause()}},set_visual_mode_burntrose:function(a,b){var c=this.fetch_instanceprops(b);switch(a){case"recordmode":c.controlbar.preview.addClass("poodll_recording"),c.controlbar.status.addClass("poodll_recording"),"audio"==c.config.mediatype&&c.controlbar.preview.addClass("hide"),c.controlbar.status.removeClass("hide");break;case"previewmode":c.controlbar.preview.removeClass("poodll_recording"),c.controlbar.status.removeClass("poodll_recording");break;case"pausedmode":c.controlbar.preview.removeClass("poodll_recording"),c.controlbar.status.removeClass("poodll_recording")}},insert_fetch_control_bar_burntrose:function(b,c,d){var e='<div class="poodll_mediarecorderbox" id="'+c+'">',f=this.fetch_status_bar("burntrose");e+=f,e+=d,e+='<span class="poodll_start-recording" title="'+M.util.get_string("recui_record","filter_poodll")+'"></span>',e+='<span class="poodll_stop-recording hide" title="'+M.util.get_string("recui_stop","filter_poodll")+"></span>",e+='<span class="poodll_pause-recording hide" title="'+M.util.get_string("recui_pause","filter_poodll")+'"></span>',e+=' <span class="poodll_resume-recording hide"title="'+M.util.get_string("recui_continue","filter_poodll")+'" ></span>',e+=' <span class="poodll_play-recording" ></span>',e+=' <span class="poodll_playsave hide" title="'+M.util.get_string("recui_play","filter_poodll")+'" ></span>',e+=' <span class="poodll_mic" ></span>',e+=' <span class="poodll_recmic hide" ></span>',e+=' <span class="poodll_resume_mic hide" ></span>',e+='<span class="poodll_savebtn" ></span>',e+='<span class="poodll_save-recording_burntrose hide" title="'+M.util.get_string("recui_save","filter_poodll")+'" ></span>',e+='<span class="poodll_savedsuccessfully hide"></span>',e+="</div>",a(b).prepend(e);var g={status:a("#"+c+" > .poodll_status_burntrose"),preview:a("#"+c+" > .poodll_preview_burntrose"),startbutton:a("#"+c+" > .poodll_start-recording"),stopbutton:a("#"+c+" > .poodll_stop-recording"),pausebutton:a("#"+c+" > .poodll_pause-recording"),resumebutton:a("#"+c+" > .poodll_resume-recording"),play1:a("#"+c+" > .poodll_play-recording"),playbutton:a("#"+c+" > .poodll_playsave"),save1:a("#"+c+" > .poodll_savebtn"),savebutton:a("#"+c+" > .poodll_save-recording_burntrose"),savesuccess:a("#"+c+" > .poodll_savedsuccessfully"),playermic:a("#"+c+"> .poodll_mic"),recordmic:a("#"+c+"> .poodll_recmic"),resumemic:a("#"+c+"> .poodll_resume_mic")};return g},insert_fetch_control_bar_video_burntrose:function(b,c,d){var e='<div class="poodll_mediavideobox" id="'+c+'">',f=this.fetch_status_bar("burntrose");e+=f,e+=d,e+='<div class="poodll_mediavideobox2" id="'+c+'">',e+='<span class="poodll_start-recording" title="'+M.util.get_string("recui_record","filter_poodll")+'"></span>',e+='<span class="poodll_stop-recording hide" title="'+M.util.get_string("recui_stop","filter_poodll")+'"></span>',e+='<span class="poodll_pause-recording hide" title="'+M.util.get_string("recui_pause","filter_poodll")+'" ></span>',e+=' <span class="poodll_resume-recording hide" title="'+M.util.get_string("recui_continue","filter_poodll")+'"></span>',e+=' <span class="poodll_play-recording" ></span>',e+=' <span class="poodll_playsave hide" title="'+M.util.get_string("recui_play","filter_poodll")+'"></span>',e+=' <span class="poodll_mic hide" ></span>',e+=' <span class="poodll_recmic hide" ></span>',e+=' <span class="poodll_resume_mic hide" ></span>',e+='<span class="poodll_savebtn "title="'+M.util.get_string("recui_save","filter_poodll")+'" ></span>',e+='<span class="poodll_save-recording_burntrose hide "title="'+M.util.get_string("recui_save","filter_poodll")+'" ></span>',e+='<span class="poodll_savedsuccessfully hide" ></span>',e+="</div>",e+="</div>",a(b).prepend(e);var g={status:a("#"+c+" > .poodll_status_burntrose"),preview:a("#"+c+" > .poodll_preview_burntrose"),startbutton:a("#"+c+" > .poodll_start-recording"),stopbutton:a("#"+c+" > .poodll_stop-recording"),pausebutton:a("#"+c+" > .poodll_pause-recording"),resumebutton:a("#"+c+" > .poodll_resume-recording"),play1:a("#"+c+" > .poodll_play-recording"),playbutton:a("#"+c+" > .poodll_playsave"),save1:a("#"+c+" > .poodll_savebtn"),savebutton:a("#"+c+" > .poodll_save-recording_burntrose"),savesuccess:a("#"+c+" > .poodll_savedsuccessfully"),playermic:a("#"+c+"> .poodll_mic"),recordmic:a("#"+c+"> .poodll_recmic"),resumemic:a("#"+c+"> .poodll_resume_mic")};return g},register_controlbar_events_burntrose:function(d,e,f){var g=this,h=this.fetch_instanceprops(f);h.controlbar.startbutton.click(function(){this.disabled=!1,a("#"+h.config.widgetid+"_messages").text(""),h.blobs=[],g.captureUserMedia(e,d,g.onMediaError),h.controlbar.playermic.hide(),h.controlbar.recordmic.show(),h.controlbar.playbutton.hide(),h.controlbar.play1.hide(),h.controlbar.pausebutton.show(),h.controlbar.pausebutton.attr("disabled",!1),h.controlbar.startbutton.hide(),h.controlbar.stopbutton.show(),h.controlbar.stopbutton.attr("disabled",!1),h.controlbar.savebutton.hide(),h.controlbar.savesuccess.hide(),h.controlbar.save1.show(),g.set_visual_mode("recordmode",f),h.timer.reset(),h.timer.start(),g.update_status(f)}),h.controlbar.stopbutton.click(function(){this.disabled=!1,h.controlbar.stopbutton.hide(),h.controlbar.startbutton.show(),h.controlbar.startbutton.attr("disabled",!1),h.controlbar.resumebutton.hide(),h.controlbar.pausebutton.hide(),h.controlbar.play1.hide(),h.controlbar.playbutton.show(),h.controlbar.save1.hide(),h.controlbar.savesuccess.hide(),h.controlbar.savebutton.show(),h.controlbar.resumemic.hide(),h.controlbar.recordmic.hide(),h.controlbar.playermic.show(),h.mediaRecorder.stop();var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause(),g.set_visual_mode("previewmode",f),h.timer.stop(),g.update_status(f),h.uploaded||h.controlbar.startbutton.attr("disabled",!1)}),h.controlbar.pausebutton.click(function(){this.disabled=!0,a(this).hide(),h.controlbar.resumebutton.show(),h.mediaRecorder.resume(),h.mediaRecorder.pause(),h.controlbar.resumebutton.attr("disabled",!1),g.set_visual_mode("pausedmode",f),h.timer.pause(),g.update_status(f),h.controlbar.recordmic.hide(),h.controlbar.resumemic.show()}),h.controlbar.resumebutton.click(function(){this.disabled=!0,a(this).hide(),h.controlbar.pausebutton.show(),h.mediaRecorder.resume(),h.controlbar.pausebutton.attr("disabled",!1),g.set_visual_mode("recordmode",f),h.timer.resume(),g.update_status(f),h.controlbar.resumemic.hide(),h.controlbar.recordmic.show()}),h.controlbar.playbutton.click(function(){this.disabled=!1;var a=h.controlbar.preview.get(0);if(a.currentTime>0&&!a.paused)return a.pause(),void(a.currentTime=0);if(h.blobs&&h.blobs.length>0)switch(b.debug("playig type:"+h.blobs[0].type),h.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(h.blobs,function(b){var c=URL.createObjectURL(b);a.src=c,a.controls=!0,a.volume=h.previewvolume,a.play()});break;case"video/webm":case"audio/ogg":case"audio/webm":default:var d=c.simpleConcatenateBlobs(h.blobs,h.blobs[0].type),e=URL.createObjectURL(d);a.src=e,a.controls=!0,a.volume=h.previewvolume,a.play();break;case"olddefault":c.concatenateBlobs(h.blobs,h.blobs[0].type,function(b){var c=URL.createObjectURL(b);a.src=c,a.controls=!0,a.volume=h.previewvolume,a.play()})}h.controlbar.startbutton.show()}),h.controlbar.savebutton.click(function(){if(this.disabled=!1,h.blobs&&h.blobs.length>0)switch(h.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(h.blobs,function(a){h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0});break;case"audio/ogg":case"audio/webm":case"video/webm":default:var a=c.simpleConcatenateBlobs(h.blobs,h.blobs[0].type);h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0;break;case"old default":c.concatenateBlobs(h.blobs,h.blobs[0].type,function(a){h.uploader.uploadBlob(a,h.blobs[0].type),h.controlbar.startbutton.attr("disabled",!0),h.uploaded=!0})}else h.uploader.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll"));return!1}),window.onbeforeunload=function(){h.controlbar.startbutton.attr("disabled",!1);var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause()}}}});