define(["jquery","core/log"],function(a,b){"use strict";return b.debug("speech_awstranscribe: initialising"),{recognition:null,recognizing:!1,ignore_onend:!1,final_transcript:"",start_timestamp:0,lang:"en-US",clone:function(){return a.extend(!0,{},this)},init:function(a){var b=b||webkitSpeechRecognition;this.recognition=new b,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.lang=a?a:"en-US",this.register_events()},set_grammar:function(a){var b=b||webkitSpeechGrammarList;if(b){var c=new b;c.addFromString(a,1),this.recognition.grammars=c}},start:function(){this.recognizing||(this.recognizing=!0,this.final_transcript="",this.recognition.lang=this.lang,this.recognition.start(),this.ignore_onend=!1,this.start_timestamp=Date.now())},stop:function(){this.recognizing=!1,this.recognition.stop()},register_events:function(){var a=this.recognition,c=this;a.onstart=function(){c.recognizing=!0},a.onerror=function(a){"no-speech"==a.error&&(b.debug("info_no_speech"),c.ignore_onend=!0),"audio-capture"==a.error&&(b.debug("info_no_microphone"),c.ignore_onend=!0),"not-allowed"==a.error&&(a.timeStamp-c.start_timestamp<100?b.debug("info_blocked"):b.debug("info_denied"),c.ignore_onend=!0)},a.onend=function(){0!=c.recognizing&&(c.ignore_onend?c.recognizing=!1:a.start())},a.onresult=function(a){for(var b="",d=a.resultIndex;d<a.results.length;++d)a.results[d].isFinal?(c.final_transcript+=a.results[d][0].transcript,c.onfinalspeechcapture(c.final_transcript),c.final_transcript=""):(b+=a.results[d][0].transcript,c.oninterimspeechcapture(b))}},onfinalspeechcapture:function(a){b.debug(a)},oninterimspeechcapture:function(a){},streamAudioToWebSocket:function(a){micStream=new mic,micStream.setStream(a);var b=createPresignedUrl();socket=new WebSocket(b),socket.binaryType="arraybuffer",socket.onopen=function(){micStream.on("data",function(a){var b=convertAudioToBinaryMessage(a);socket.OPEN&&socket.send(b)})},wireSocketEvents()},wireSocketEvents:function(){socket.onmessage=function(a){var b=eventStreamMarshaller.unmarshall(Buffer(a.data)),c=JSON.parse(String.fromCharCode.apply(String,b.body));"event"===b.headers[":message-type"].value?handleEventStreamMessage(c):(transcribeException=!0,showError(c.Message),toggleStartStop())},socket.onerror=function(){socketError=!0,showError("WebSocket connection error. Try again."),toggleStartStop()},socket.onclose=function(a){micStream.stop(),socketError||transcribeException||(1e3!=a.code&&showError("</i><strong>Streaming Exception</strong><br>"+a.reason),toggleStartStop())}},handleEventStreamMessage:function(b){var c=b.Transcript.Results;if(c.length>0&&c[0].Alternatives.length>0){var d=c[0].Alternatives[0].Transcript;d=decodeURIComponent(escape(d)),a("#transcript").val(transcription+d+"\n"),c[0].IsPartial||(a("#transcript").scrollTop(a("#transcript")[0].scrollHeight),transcription+=d+"\n")}},convertAudioToBinaryMessage:function(a){var b=mic.toRaw(a);if(null!=b){var c=audioUtils.downsampleBuffer(b,sampleRate),d=audioUtils.pcmEncode(c),e=getAudioEventMessage(Buffer.from(d)),f=eventStreamMarshaller.marshall(e);return f}},getAudioEventMessage:function(a){return{headers:{":message-type":{type:"string",value:"event"},":event-type":{type:"string",value:"AudioEvent"}},body:a}},createPresignedUrl:function(){var b="transcribestreaming."+region+".amazonaws.com:8443";return v4.createPresignedURL("GET",b,"/stream-transcription-websocket","transcribe",crypto.createHash("sha256").update("","utf8").digest("hex"),{key:a("#access_id").val(),secret:a("#secret_key").val(),protocol:"wss",expires:15,region:region,query:"language-code="+languageCode+"&media-encoding=pcm&sample-rate="+sampleRate})},closeSocket:function(){if(socket.OPEN){micStream.stop();var a=getAudioEventMessage(Buffer.from(new Buffer([]))),b=eventStreamMarshaller.marshall(a);socket.send(b)}}}});