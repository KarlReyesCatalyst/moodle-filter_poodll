define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,init:function(a,b){this.config=b,this.insert_controls(a)},insert_controls:function(b){var c='<div id="'+this.config.widgetid+'_progress" class="p_progress x"><p></p></div>';c+='<div id="'+this.config.widgetid+'_messages" class="p_messages x"></div>',a(b).append(c)},uploadBlob:function(a,b){var c=this,d="",e=new FileReader;e.onloadend=function(a){d=a.target.result,c.uploadFile(d,b)},e.readAsDataURL(a)},extractFilename:function(a){var b=a.indexOf("success<filename>");if(1>b)return!1;var c=a.indexOf("</filename>");a.substring(b+14,c)},createProgressBar:function(b,c){var d=!1,e=a("#"+c.config.widgetid+"_progress");if(e.length){var f=e.get(0);d=f.firstChild,null==d&&(d=f.appendChild(document.createElement("p"))),d.className="",d.style.display="block",d.style.backgroundPosition="100% 0",b.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);d.style.backgroundPosition=b+"% 0"},!1)}return d},fetchFileExtension:function(a){var b="";switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"video/quicktime":b="mov";break;case"audio/mpeg3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/mpeg3":b="mp3";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/mp4":b="mp4";break;case"video/webm":b="webm"}return b},postProcessUpload:function(c,d){var e=c.currentTarget;if(4==e.readyState)if(200==e.status){var f=d.config.filename;if(f||(f=d.extractFilename(e.responseText)),!f)return b.debug("upload failed #1"),void b.debug(e);if(d.config.callbackjs&&""!=d.config.callbackjs){var g=new Array;g[0]=d.config.widgetid,g[1]="filesubmitted",g[2]=f,g[3]=d.config.updatecontrol,this.Output("File saved successfully."),this.executeFunctionByName(d.config.callbackjs,window,g)}else{this.Output("File saved successfully.");var h=a("#"+d.config.updatecontrol);h.length>0?h.get(0).value=f:(h=window.parent.document.getElementById(d.config.updatecontrol),h?h.value=f:(b.debug("upload failed #2"),b.debug(e),d.Output("File could not be uploaded.")))}}else b.debug("upload failed #3"),b.debug(e),d.Output("File could not be uploaded.")},uploadFile:function(a,c){var d=new XMLHttpRequest,e=this.config,f=this,g=this.fetchFileExtension(c);this.createProgressBar(d,f);this.Output("Uploading."),d.upload.addEventListener("load",function(){console.log("uploaded:")}),d.onreadystatechange=function(a){f.postProcessUpload(a,f)};var h="datatype=uploadfile";h+="&paramone="+encodeURIComponent(a),h+="&paramtwo="+g,h+="&paramthree="+e.mediatype,h+="&requestid="+e.widgetid,h+="&contextid="+e.p2,h+="&component="+e.p3,h+="&filearea="+e.p4,h+="&itemid="+e.p5,b.debug(e);var i=!0;i?(d.open("put",e.posturl,!0),d.setRequestHeader("Content-Type","application/octet-stream"),d.send(encodeURIComponent(a))):(d.open("POST",e.posturl,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.setRequestHeader("Content-length",h.length),d.setRequestHeader("Connection","close"),d.send(h))},Output:function(b){var c=a("#"+this.config.widgetid+"_messages");c.text(b)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)}}});