define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,init:function(a,b){this.config=b,this.insert_controls(a)},insert_controls:function(b){var c='<div id="'+this.config.widgetid+'_progress" class="p_progress x"><p></p></div>';c+='<div id="'+this.config.widgetid+'_messages" class="p_messages x"></div>',a(b).append(c)},uploadBlob:function(a,b){var c=this,d="",e=new FileReader;e.onloadend=function(a){d=a.target.result,c.uploadFile(d,b)},e.readAsDataURL(a)},uploadFile:function(c,d){var e=new XMLHttpRequest,f=this.config,g="";switch(d){case"image/jpeg":g="jpg";break;case"image/png":g="png";break;case"audio/wav":g="wav";break;case"video/quicktime":g="mov";break;case"audio/mpeg3":g="mp3";break;case"audio/webm":g="webm";break;case"audio/x-mpeg-3":g="mp3";break;case"audio/mpeg3":g="mp3";break;case"audio/3gpp":g="3gpp";break;case"video/mpeg3":g="3gpp";break;case"video/mp4":g="mp4";break;case"video/webm":g="webm"}var h=a("#"+f.widgetid+"_progress");if(h.length){var i=h.get(0),j=i.firstChild;null==j&&(j=i.appendChild(document.createElement("p"))),j.className="",j.style.display="block",j.style.backgroundPosition="100% 0",e.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);j.style.backgroundPosition=b+"% 0"},!1)}else var j=!1;this.Output("Uploading."),e.onreadystatechange=function(b){return function(c){if(4==e.readyState)if(j&&(j.className=200==e.status?"success":"failure"),200==e.status){var d=e.responseText,g=d.indexOf("success<error>");if(1>g)return;var h=d.indexOf("</error>"),i=d.substring(g+14,h);if(f.callbackjs&&""!=f.callbackjs){var k=new Array;k[0]=f.widgetid,k[1]="filesubmitted",k[2]=i,k[3]=f.updatecontrol,b.Output("File saved successfully."),b.executeFunctionByName(f.callbackjs,window,k)}else{b.Output("File saved successfully.");var l=a("#"+f.updatecontrol);l.length>0?l.get(0).value=i:(l=window.parent.document.getElementById(f.updatecontrol),l?l.value=i:b.Output("File could not be uploaded."))}}else b.Output("File could not be uploaded.")}}(this);var k="datatype=uploadfile";k+="&paramone="+encodeURIComponent(c),k+="&paramtwo="+g,k+="&paramthree="+f.mediatype,k+="&requestid="+f.widgetid,k+="&contextid="+f.p2,k+="&component="+f.p3,k+="&filearea="+f.p4,k+="&itemid="+f.p5,b.debug(f),e.open("POST",f.posturl,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Cache-Control","no-cache"),e.setRequestHeader("Content-length",k.length),e.setRequestHeader("Connection","close"),e.send(k)},Output:function(b){var c=a("#"+this.config.widgetid+"_messages");c.text(b)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)}}});